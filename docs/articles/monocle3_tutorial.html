<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial: countsplitting with Monocle3 • countsplit</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial: countsplitting with Monocle3">
<meta property="og:description" content="countsplit">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">countsplit</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/countsplit_tutorial.html">Introductory tutorial</a>
</li>
<li>
  <a href="../articles/seurat_tutorial.html">Seurat tutorial</a>
</li>
<li>
  <a href="../articles/scran_tutorial.html">Scran tutorial</a>
</li>
<li>
  <a href="../articles/monocle3_tutorial.html">Monocle3 tutorial</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/anna-neufeld/countsplit/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial: countsplitting with Monocle3</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/anna-neufeld/countsplit/blob/HEAD/vignettes/monocle3_tutorial.Rmd" class="external-link"><code>vignettes/monocle3_tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>monocle3_tutorial.Rmd</code></div>

    </div>

    
    
<p>Before using this tutorial, we recommend that you read through our <a href="https://anna-neufeld.github.io/countsplit/articles/countsplit_tutorial.html" class="external-link">introductory tutorial</a> to understand our method in a simple example with simulated data.</p>
<p>For this tutorial, we reproduce the Monocle3 <a href="https://cole-trapnell-lab.github.io/monocle3/docs/trajectories/" class="external-link">vignette</a>, but we apply count splitting. Throughout the tutorial, we see that we reach similar takeaways to those reached in the Monocle3 vignette, despite the fact that we estimate pseudotime using only the training set.</p>
<div class="section level2">
<h2 id="install-monocle3">Install Monocle3<a class="anchor" aria-label="anchor" href="#install-monocle3"></a>
</h2>
<p>If you don’t already have <code>Monocle3</code>, you will need to install it. Please visit <a href="https://cole-trapnell-lab.github.io/monocle3/docs/installation/" class="external-link">this link</a> for installation details. As <code>Monocle3</code> is in Beta, there may be some trouble shooting involved.</p>
<p>Next, you should load the package, along with others that we will use in this tutorial.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">monocle3</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/anna-neufeld/countsplit" class="external-link">countsplit</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-the-data-and-create-a-cell_data_set">Load the data and create a cell_data_set<a class="anchor" aria-label="anchor" href="#load-the-data-and-create-a-cell_data_set"></a>
</h2>
<p>We load the same data that is used in the Monocle3 vignette.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">expression_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://depts.washington.edu:/trapnell-lab/software/monocle3/celegans/data/packer_embryo_expression.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="va">cell_metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://depts.washington.edu:/trapnell-lab/software/monocle3/celegans/data/packer_embryo_colData.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="va">gene_annotation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://depts.washington.edu:/trapnell-lab/software/monocle3/celegans/data/packer_embryo_rowData.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We now deviate from the Monocle3 vignette to apply count splitting. We apply count splitting directly to the raw expression matrix. We then construct a <code>cell_data_set</code> object (used by the Monocle3 package) that contains only the training set counts.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">epsilon</span><span class="op">=</span><span class="fl">0.5</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">Xtrain</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">expression_matrix</span>,<span class="fl">2</span>,<span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>, size<span class="op">=</span><span class="va">u</span>, p<span class="op">=</span><span class="va">epsilon</span><span class="op">)</span><span class="op">)</span>
<span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="va">expression_matrix</span><span class="op">-</span><span class="va">Xtrain</span>
<span class="va">cds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/new_cell_data_set.html" class="external-link">new_cell_data_set</a></span><span class="op">(</span>
  <span class="va">Xtrain</span>,
  cell_metadata <span class="op">=</span> <span class="va">cell_metadata</span>,
  gene_metadata <span class="op">=</span> <span class="va">gene_annotation</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preprocess-the-data">Preprocess the data<a class="anchor" aria-label="anchor" href="#preprocess-the-data"></a>
</h2>
<p>We now follow the preprocessing and pseudotime steps from the Monocle3 tutorial to come up with pseudotime estimates. Everything in this section uses the training set only.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/preprocess_cds.html" class="external-link">preprocess_cds</a></span><span class="op">(</span><span class="va">cds_train</span>, num_dim <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">cds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/align_cds.html" class="external-link">align_cds</a></span><span class="op">(</span>
  <span class="va">cds_train</span>, 
  alignment_group <span class="op">=</span> <span class="st">"batch"</span>, 
  residual_model_formula_str <span class="op">=</span> <span class="st">"~ bg.300.loading + bg.400.loading + bg.500.1.loading +    
      bg.500.2.loading + bg.r17.loading + bg.b01.loading + bg.b02.loading"</span>
  <span class="op">)</span></code></pre></div>
<p>The plot below shows that the cells cluster nicely by their cell type in reduced dimensions. This suggests that count splitting the data has not destroyed the signal in the data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/reduce_dimension.html" class="external-link">reduce_dimension</a></span><span class="op">(</span><span class="va">cds_train</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/plot_cells.html" class="external-link">plot_cells</a></span><span class="op">(</span><span class="va">cds_train</span>, 
           label_groups_by_cluster<span class="op">=</span><span class="cn">FALSE</span>,  
           color_cells_by <span class="op">=</span> <span class="st">"cell.type"</span><span class="op">)</span></code></pre></div>
<p><img src="monocle3_tutorial_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="estimate-pseudotime">Estimate pseudotime<a class="anchor" aria-label="anchor" href="#estimate-pseudotime"></a>
</h2>
<p>In this section, we use the training dataset to learn the graph that will be used to estimate pseudotime. For simplicity in this tutorial, we would like to only have one pseudotime trajectory with one root node. Thus, we add the <code>use_partition=FALSE</code> argument to the <code>learn_graph</code> function to ensure that our graph is made up of a single connected trajectory.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/cluster_cells.html" class="external-link">cluster_cells</a></span><span class="op">(</span><span class="va">cds_train</span><span class="op">)</span>
<span class="va">cds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/learn_graph.html" class="external-link">learn_graph</a></span><span class="op">(</span><span class="va">cds_train</span>, use_partition<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Once the graph is learned, Monocle3 computes pseudotime with the <code><a href="https://rdrr.io/pkg/monocle3/man/order_cells.html" class="external-link">order_cells()</a></code> function. This function simply projects the cells onto the principal graph to get a one dimensional representation. The only additional step is picking a root node in the graph that will correspond to <code>0</code> in pseudotime space. To pick a root node for pseudotime, we use the same method as in the Monocle3 <a href="https://cole-trapnell-lab.github.io/monocle3/docs/trajectories/" class="external-link">vignette</a>. We pick the cell from the first time bin that is closest to a graph vertex.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_earliest_principal_node</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cds</span>, <span class="va">time_bin</span><span class="op">=</span><span class="st">"130-170"</span><span class="op">)</span><span class="op">{</span>
  <span class="va">cell_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">cds</span><span class="op">)</span><span class="op">[</span>, <span class="st">"embryo.time.bin"</span><span class="op">]</span> <span class="op">==</span> <span class="va">time_bin</span><span class="op">)</span>
  <span class="va">closest_vertex</span> <span class="op">&lt;-</span>
  <span class="va">cds</span><span class="op">@</span><span class="va">principal_graph_aux</span><span class="op">[[</span><span class="st">"UMAP"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pr_graph_cell_proj_closest_vertex</span>
  <span class="va">closest_vertex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">closest_vertex</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cds</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
  <span class="va">root_pr_nodes</span> <span class="op">&lt;-</span>
  <span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/V.html" class="external-link">V</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/principal_graph.html" class="external-link">principal_graph</a></span><span class="op">(</span><span class="va">cds</span><span class="op">)</span><span class="op">[[</span><span class="st">"UMAP"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">name</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span>
  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">closest_vertex</span><span class="op">[</span><span class="va">cell_ids</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
  <span class="va">root_pr_nodes</span>
<span class="op">}</span>
<span class="va">cds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/order_cells.html" class="external-link">order_cells</a></span><span class="op">(</span><span class="va">cds_train</span>, root_pr_nodes<span class="op">=</span><span class="fu">get_earliest_principal_node</span><span class="op">(</span><span class="va">cds_train</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We now have estimated pseudotime, and we can plot our learned graph with cells colored by pseudotime.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/plot_cells.html" class="external-link">plot_cells</a></span><span class="op">(</span><span class="va">cds_train</span>,
           color_cells_by <span class="op">=</span> <span class="st">"pseudotime"</span>,
           label_cell_groups<span class="op">=</span><span class="cn">FALSE</span>,
           label_leaves<span class="op">=</span><span class="cn">FALSE</span>,
           label_branch_points<span class="op">=</span><span class="cn">FALSE</span>,
           graph_label_size<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></code></pre></div>
<p><img src="monocle3_tutorial_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="finding-genes-that-are-differentially-expressed-across-pseudotime">Finding genes that are differentially expressed across pseudotime<a class="anchor" aria-label="anchor" href="#finding-genes-that-are-differentially-expressed-across-pseudotime"></a>
</h2>
<p>Now that we have estimated pseudotime using the training set, we are ready to study differential expression along pseudotime. In this section, we rely on the pseudotime from the training set but we rely on the test set counts for differential expression analysis.</p>
<div class="section level3">
<h3 id="by-hand">By hand<a class="anchor" aria-label="anchor" href="#by-hand"></a>
</h3>
<p>First, we carry out differential expression testing “by hand.” We fit a quasipoisson GLM of each test set gene onto the pseudotime computed from the training set. (We choose quasipoisson since this is the default family for the <code><a href="https://rdrr.io/pkg/monocle3/man/fit_models.html" class="external-link">fit_models()</a></code> function in Monocle3.) For computational efficiency, we only do this for the first 500 genes. We include the size factors estimated on the training as offsets in the regression.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pseudotime.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/pseudotime.html" class="external-link">pseudotime</a></span><span class="op">(</span><span class="va">cds_train</span><span class="op">)</span>
<span class="va">sf.train</span> <span class="op">&lt;-</span> <span class="fu">colData</span><span class="op">(</span><span class="va">cds_train</span><span class="op">)</span><span class="op">$</span><span class="va">Size_Factor</span>
<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Xtest</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span>,<span class="op">]</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">u</span><span class="op">~</span><span class="va">pseudotime.train</span>, offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sf.train</span><span class="op">)</span>, family<span class="op">=</span><span class="st">"quasipoisson"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">results</span>, n<span class="op">=</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## WBGene00010957 WBGene00010958 WBGene00010959 WBGene00010960 WBGene00010961 </span>
<span class="co">##    0.002260399    0.007547423    0.002622328    0.002473421    0.005321465 </span>
<span class="co">## WBGene00000829 WBGene00010962 WBGene00010963 WBGene00010964 WBGene00010965 </span>
<span class="co">##    0.002964884    0.002445576    0.003913811    0.002597764    0.002211407</span></code></pre>
<p>The results above show the differential expression p-value for each of the first 10 genes in the dataset.</p>
</div>
<div class="section level3">
<h3 id="using-monocle3s-graph-test">Using Monocle3’s Graph Test<a class="anchor" aria-label="anchor" href="#using-monocle3s-graph-test"></a>
</h3>
<p>This section follows the “finding genes that change as a function of pseudotime” <a href="https://cole-trapnell-lab.github.io/monocle3/docs/differential/#pseudo-dep" class="external-link">section</a> of the Monocle3 vignette. The differential expression testing method recommended in the Monocle3 tutorial is <code><a href="https://rdrr.io/pkg/monocle3/man/graph_test.html" class="external-link">graph_test()</a></code>, which uses Moran’s I statistics to test if cells that are adjacent in pseudotime space have similar expression values for certain genes.</p>
<p>In this section, we will need our test set to be stored in a <code>cell_data_set</code> that contains the test set counts. We need this object to store the training set graph. To accomplish this, we make a copy of <code>cds_train</code> and only update the counts.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cds_test</span> <span class="op">&lt;-</span> <span class="va">cds_train</span> 
<span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">cds_test</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">Xtest</span> </code></pre></div>
<p>We now run the <code>graph_test</code> function, which is the preferred Monocle3 methodology for finding genes that vary across pseudotime.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ciliated_cds_pr_test_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/graph_test.html" class="external-link">graph_test</a></span><span class="op">(</span><span class="va">cds_test</span>, neighbor_graph<span class="op">=</span><span class="st">"principal_graph"</span>, cores<span class="op">=</span><span class="fl">4</span><span class="op">)</span> 
<span class="va">pr_deg_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ciliated_cds_pr_test_res</span>, <span class="va">q_value</span> <span class="op">&lt;</span> <span class="fl">0.0005</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p>Here are a couple of interesting genes that score as highly significant according to <code><a href="https://rdrr.io/pkg/monocle3/man/graph_test.html" class="external-link">graph_test()</a></code>, both in our analysis and in the analysis in the Monocle3 vignette. We can see that the expression levels of these genes do vary a lot in pseudotime space (these genes are highly expressed in very specific regions of the graph).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/plot_cells.html" class="external-link">plot_cells</a></span><span class="op">(</span><span class="va">cds_test</span>, genes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hlh-4"</span>, <span class="st">"gcy-8"</span>, <span class="st">"dac-1"</span>, <span class="st">"oig-8"</span><span class="op">)</span>, 
          show_trajectory_graph<span class="op">=</span><span class="cn">FALSE</span>, 
           label_cell_groups<span class="op">=</span><span class="cn">FALSE</span>, 
           label_leaves<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> </code></pre></div>
<p><img src="monocle3_tutorial_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>We can also select specific genes and plot their expression across pseudotime. As in the Monocle3 vignette, we see that all three of these genes get “activated” midway through the trajectory, but <code>dac-1</code> is activated slightly before the others.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">AFD_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gcy-8"</span>, <span class="st">"dac-1"</span>, <span class="st">"oig-8"</span><span class="op">)</span>
<span class="va">AFD_lineage_cds</span> <span class="op">&lt;-</span> <span class="va">cds_test</span><span class="op">[</span><span class="fu">rowData</span><span class="op">(</span><span class="va">cds_test</span><span class="op">)</span><span class="op">$</span><span class="va">gene_short_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">AFD_genes</span>, 
                       <span class="fu">colData</span><span class="op">(</span><span class="va">cds_test</span><span class="op">)</span><span class="op">$</span><span class="va">cell.type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AFD"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/monocle3/man/plot_genes_in_pseudotime.html" class="external-link">plot_genes_in_pseudotime</a></span><span class="op">(</span><span class="va">AFD_lineage_cds</span>,                          color_cells_by<span class="op">=</span><span class="st">"embryo.time.bin"</span>,min_expr<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> </code></pre></div>
<p><img src="monocle3_tutorial_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>The analysis in this tutorial identifies differentially expressed genes without double dipping in the data, and thus improves upon the analysis in the Monocle3 <a href="https://cole-trapnell-lab.github.io/monocle3/docs/trajectories/" class="external-link">vignette</a>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Anna Neufeld.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.4.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
